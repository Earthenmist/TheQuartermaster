name: Discord notifications

on:
  release:
    types: [published]
  push:
    branches: ["main", "master"]
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review, converted_to_draft]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build Discord message
        id: msg
        shell: bash
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"

          # Default to dev webhook; override for releases
          WEBHOOK="${{ secrets.DISCORD_WEBHOOK_DEV }}"

          if [ "$EVENT" = "release" ]; then
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK_RELEASE }}"
            NAME="${{ github.event.release.name }}"
            TAG="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            BODY="## üöÄ ${NAME:-New Release} (${TAG})\n**Repo:** ${REPO}\n**Link:** ${URL}"

          elif [ "$EVENT" = "push" ]; then
            # Only show the top commit to keep it readable
            BRANCH="${{ github.ref_name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
            SHORT_SHA="$(echo "${{ github.sha }}" | cut -c1-7)"

            # Trim commit message to first line
            COMMIT_FIRST_LINE="$(echo "$COMMIT_MSG" | head -n 1)"

            BODY="**üìù Push** to \`${BRANCH}\` ‚Äî \`${SHORT_SHA}\`\n**Repo:** ${REPO}\n**Message:** ${COMMIT_FIRST_LINE}\n**Link:** ${COMMIT_URL}"

          elif [ "$EVENT" = "issues" ]; then
            ACTION="${{ github.event.action }}"
            NUM="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"

            EMOJI="ü™≤"
            if [ "$ACTION" = "closed" ]; then EMOJI="‚úÖ"; fi

            BODY="**${EMOJI} Issue ${ACTION}** ‚Äî #${NUM}\n**Repo:** ${REPO}\n**Title:** ${TITLE}\n**Link:** ${URL}"

          elif [ "$EVENT" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            NUM="${{ github.event.pull_request.number }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"

            EMOJI="üîÄ"
            if [ "$ACTION" = "closed" ]; then
              # If merged, show a nicer status
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                ACTION="merged"
                EMOJI="‚úÖ"
              else
                EMOJI="üö´"
              fi
            fi

            BODY="**${EMOJI} PR ${ACTION}** ‚Äî #${NUM}\n**Repo:** ${REPO}\n**Title:** ${TITLE}\n**Link:** ${URL}"

          else
            BODY="GitHub event: ${EVENT} in ${REPO} by ${ACTOR}"
          fi

          # Escape quotes for JSON
          BODY_ESCAPED=$(python3 - << 'PY'
import json, os
print(json.dumps({"content": os.environ["BODY"]}))
PY
          )
          echo "webhook=$WEBHOOK" >> "$GITHUB_OUTPUT"
          echo "payload=$BODY_ESCAPED" >> "$GITHUB_OUTPUT"
        env:
          BODY: ${{ env.BODY }}

      - name: Send to Discord
        shell: bash
        run: |
          curl -sS -H "Content-Type: application/json" \
            -d '${{ steps.msg.outputs.payload }}' \
            '${{ steps.msg.outputs.webhook }}'
